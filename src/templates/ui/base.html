{% extends 'base.html' %}
{% load compress %}
{% load static %}

{% block head %}
    <script type="text/javascript" src="{% url "ui:api" %}?v={{ PROGRAM_VERSION }}і"></script>
    <script type="text/javascript" src="{% static "js/ui-head.js" %}"></script>
    <script type="text/javascript" src="{% static "js/Ext.ux.grid.CheckColumn.js" %}"></script>
    <script type="text/javascript" src="{% static "js/Ext.stores.js" %}"></script>
    {% compress js %}
{#    <script type="text/javascript" src="{% static "js/Ext.ux.components.js"></script>#}
    <script type="text/javascript" src="{% static "js/components/Ext.ux.msg.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.traceback.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.LoginForm.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.LoginWindow.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.TabPanel.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.menu.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.MenuBar.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.CustomGridNE.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.CustomGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.CityGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.StreetGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.HouseNumGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.BuildingGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.IllegalGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.WarningGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.AbonentGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.CardGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.SourceCombo.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.RegisterGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.RegisterForm.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.PersonForm.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.StreetCombo.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.HouseCombo.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.AddressForm.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.BalanceForm.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.FreeCardCombo.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.AbonCardsGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.CardTpCombo.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.AbonCardsTpGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.AbonPaymentsGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.AbonFeesGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.AbonOperationsGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.AbonHistoryGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.AbonCreditsGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.AbonIllegalGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.AbonWarningGrid.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.AbonCommentsPanel.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.AbonInfoPanel.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.AbonentForm.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.PaymentForm.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.FeeForm.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.DisableForm.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.EnableForm.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.TransferForm.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.AbonTpMoveCombo.js" %}"></script>
    <script type="text/javascript" src="{% static "js/components/Ext.ux.AbonTpMoveForm.js" %}"></script>
    {% endcompress %}
    <script type="text/javascript" src="{% static "js/Ext.ux.MainViewport.js" %}"></script>
    <script type="text/javascript">
        Ext.BLANK_IMAGE_URL = '{% static "extjs/resources/images/default/s.gif" %}"';
        Ext.QuickTips.init();
        
        Ext.apply(Ext.QuickTips.getQuickTip(), {
            showDelay: 1000
        });

        Ext.Ajax.on('requestcomplete', function(req,response){        	
            batch = eval(response.responseText)
            for(line in batch) {
                if(isInt(line)) {
                    data = batch[line]
                    if(Ext.isArray(data.result)) {
                        for(line in data.result) {                          
                        	$("#traceback-content").val()
                          	result = data.result[line]
                          	if(!result){
                          		continue
                          	}
                          	if(data.result.errors){
                        		Ext.ux.traceback('Критическая ошибка',data.result.errors,getCookie('csrftoken'))
                            }
                        	else if(result.msg && result.title) {
                          		if(result.success) {
                    		 		Ext.ux.msg(result.title, result.msg, Ext.Msg.INFO);
                        		} else {
                             		Ext.ux.msg(result.title, result.msg, Ext.Msg.ERROR);
                        		}
                    		}                    		
                        }
                    }
                    if(data.result.errors){
                        Ext.ux.traceback('Критическая ошибка',data.result.errors,getCookie('csrftoken'))                             	
                    }
                    else if(data.result.msg && data.result.title) {
                    	if(data.result.success) {
                    		 Ext.ux.msg(data.result.title, data.result.msg, Ext.Msg.INFO);
                        } else {
                             Ext.ux.msg(data.result.title, data.result.msg, Ext.Msg.ERROR);                             
                        }
                    }
                }                    
            }            
        }, this);

        Ext.Ajax.on('requestexception', function(){
            Ext.ux.msg('Failure', 'Request failed', Ext.Msg.ERROR);
        }, this);
        
        Ext.Direct.on('exception', function(event){            
            Ext.ux.msg('RPC Error', event.result.error, Ext.Msg.ERROR);
        });

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?

                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!(/^http:.*/.test(settings.url) || /^https:.*/.test(settings.url))) {
                    // Only send the token to relative URLs i.e. locally.
                    xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                    xhr.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                }
            },
            dataType: 'json',
            error:function(jqXHR, textStatus, errorThrown){
                alert(textStatus +'\n'+ errorThrown)
            }
        });

    </script>
{% endblock %}

{% block body %}
	{% csrf_token %}
    <div id="loading-mask" style=""></div>
    <div id="loading-mask-half" style=""></div>
    <div id="loading">
        <div class="loading-indicator">
            <!-- <img src="{% static "img/ajax-loader2.gif" %}" width="100" height="100" style="margin-right:8px;" align="absmiddle"/>
			-->
        </div>
    </div>

        
    {% block content %}{% endblock %}
    
    <script type="text/javascript">
    Ext.onReady(function(){
		
		Ext.Ajax.timeout = 60000;  
		
		/*
		 *  CSRF and ExtJS
		 *  http://djbook.ru/examples/22/
		 */
		
		window.getCookie = function(name) {
          var cookieValue = null;
          if (document.cookie && document.cookie != '') {
              var cookies = document.cookie.split(';');
              for (var i = 0; i < cookies.length; i++) {
                  var cookie = jQuery.trim(cookies[i]);
                  // Does this cookie string begin with the name we want?
                      if (cookie.substring(0, name.length + 1) == (name + '=')) {
                          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                          break;
                      }
              }
          }
          return cookieValue;
	    };
		
		Ext.Ajax.on('beforerequest', function(conn, options){
          if (!(/^http:.*/.test(options.url) || /^https:.*/.test(options.url))) {
              options.headers = options.headers || {};
              options.headers["X-CSRFToken"] = getCookie('csrftoken');
          }              
      	}, this);
		
        setTimeout(function(){            
            Ext.get('loading-mask').fadeOut();
        }, 250);
    });
    </script> 
{% endblock %}